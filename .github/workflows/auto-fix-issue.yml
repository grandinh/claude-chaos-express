name: Auto-Fix Issue

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to auto-fix'
        required: true
        type: number

jobs:
  trigger-auto-fix:
    runs-on: ubuntu-latest
    # Only trigger for issues with 'auto-fix' label
    if: |
      (github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'auto-fix')) ||
      (github.event.action == 'labeled' && github.event.label.name == 'auto-fix') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Get Issue Number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Check Issue Labels
        id: labels
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          # Get issue labels
          LABELS=$(gh issue view $ISSUE_NUMBER --json labels -q '.labels[].name' | tr '\n' ',' | sed 's/,$//')
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          
          # Check for excluded labels
          EXCLUDED=("complex" "manual-review" "security" "breaking-change" "database")
          SKIP=false
          for label in $LABELS; do
            for excluded in "${EXCLUDED[@]}"; do
              if [ "$label" = "$excluded" ]; then
                echo "‚ö†Ô∏è Issue has excluded label: $excluded"
                SKIP=true
                break
              fi
            done
          done
          
          echo "skip=$SKIP" >> $GITHUB_OUTPUT

      - name: Skip if Excluded Labels Present
        if: steps.labels.outputs.skip == 'true'
        run: |
          echo "‚è≠Ô∏è Skipping auto-fix due to excluded labels"
          gh issue comment ${{ steps.issue.outputs.number }} --body "ü§ñ Auto-fix agent: Skipping automatic fix due to excluded labels (complex, manual-review, security, breaking-change, or database). Please handle this issue manually."
          exit 0

      - name: Get Issue Details
        id: issue-details
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          gh issue view $ISSUE_NUMBER --json title,body > /tmp/issue.json
          TITLE=$(jq -r '.title' /tmp/issue.json)
          BODY=$(jq -r '.body' /tmp/issue.json)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Trigger Cursor Cloud Agent
        id: trigger-auto-fix
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue-details.outputs.title }}
          ISSUE_BODY: ${{ steps.issue-details.outputs.body }}
        run: |
          set -e  # Exit on any error
          set -o pipefail  # Exit on pipe failures
          
          # Read Cloud Agent config
          CONFIG_FILE=".cursor/cloud-agents/auto-fix-issue.json"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå Cloud Agent config not found: $CONFIG_FILE"
            exit 1
          fi
          
          # Prepare agent prompt with issue details
          PROMPT=$(cat <<EOF
          Analyze and fix GitHub Issue #$ISSUE_NUMBER
          
          **Title:** $ISSUE_TITLE
          
          **Description:**
          $ISSUE_BODY
          
          Follow the auto-fix-issue agent workflow:
          1. Analyze the issue
          2. Create branch: feature/auto-fix-$ISSUE_NUMBER
          3. Implement the fix
          4. Create PR linking to issue #$ISSUE_NUMBER
          EOF
          )
          
          # Call Cursor Cloud Agents API
          # Temporarily disable set -e for curl to handle errors explicitly
          set +e
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.cursor.com/v0/agents" \
            -H "Authorization: Bearer $CURSOR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"agentConfig\": $(cat $CONFIG_FILE),
              \"repository\": \"${{ github.repository }}\",
              \"branch\": \"feature/auto-fix-$ISSUE_NUMBER\",
              \"targetBranch\": \"main\",
              \"prompt\": $(echo "$PROMPT" | jq -Rs .),
              \"autoCreatePR\": true,
              \"webhook\": {
                \"url\": \"${{ secrets.WEBHOOK_URL }}\",
                \"events\": [\"completed\", \"failed\"]
              }
            }")
          CURL_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          # Check if curl command itself failed
          if [ $CURL_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Failed to connect to Cursor Cloud Agents API (curl exit code: $CURL_EXIT_CODE)"
            gh issue comment $ISSUE_NUMBER --body "ü§ñ Auto-fix agent: Failed to connect to Cursor Cloud Agents API. Please check API key and network connectivity."
            exit 1
          fi
          
          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          # Check HTTP status code
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "‚ùå API request failed with HTTP $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            gh issue comment $ISSUE_NUMBER --body "ü§ñ Auto-fix agent: API request failed with HTTP $HTTP_CODE. Error: $RESPONSE_BODY"
            exit 1
          fi
          
          # Extract agent ID from response
          AGENT_ID=$(echo "$RESPONSE_BODY" | jq -r '.id // empty')
          
          if [ -z "$AGENT_ID" ] || [ "$AGENT_ID" = "null" ]; then
            echo "‚ùå Failed to create agent - no agent ID in response"
            echo "Response: $RESPONSE_BODY"
            gh issue comment $ISSUE_NUMBER --body "ü§ñ Auto-fix agent: Failed to start. Error: $RESPONSE_BODY"
            exit 1
          fi
          
          echo "‚úÖ Agent started: $AGENT_ID"
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
          
          # Comment on issue
          gh issue comment $ISSUE_NUMBER --body "ü§ñ Auto-fix agent started. Agent ID: \`$AGENT_ID\`\n\nI'll analyze the issue and create a fix. This may take 10-30 minutes."

      - name: Monitor Agent Status
        if: steps.trigger-auto-fix.outputs.agent_id != ''
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          AGENT_ID: ${{ steps.trigger-auto-fix.outputs.agent_id }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          echo "‚è≥ Monitoring agent status..."
          
          MAX_ATTEMPTS=60  # 30 minutes max (30s * 60)
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(curl -s -H "Authorization: Bearer $CURSOR_API_KEY" \
              "https://api.cursor.com/v0/agents/$AGENT_ID" | jq -r '.status // "unknown"')
            
            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: Status = $STATUS"
            
            if [ "$STATUS" = "completed" ]; then
              echo "‚úÖ Agent completed successfully"
              
              # Get PR URL from agent response
              PR_URL=$(curl -s -H "Authorization: Bearer $CURSOR_API_KEY" \
                "https://api.cursor.com/v0/agents/$AGENT_ID" | jq -r '.prUrl // empty')
              
              if [ -n "$PR_URL" ]; then
                gh issue comment $ISSUE_NUMBER --body "‚úÖ Auto-fix completed! PR created: $PR_URL"
              else
                gh issue comment $ISSUE_NUMBER --body "‚úÖ Auto-fix completed! Check for new PRs."
              fi
              
              exit 0
            elif [ "$STATUS" = "failed" ]; then
              echo "‚ùå Agent failed"
              
              ERROR=$(curl -s -H "Authorization: Bearer $CURSOR_API_KEY" \
                "https://api.cursor.com/v0/agents/$AGENT_ID" | jq -r '.error // "Unknown error"')
              
              gh issue comment $ISSUE_NUMBER --body "‚ùå Auto-fix failed. Error: $ERROR\n\nPlease review manually or provide more details."
              
              exit 1
            fi
            
            sleep 30
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "‚è±Ô∏è Timeout waiting for agent completion"
          gh issue comment $ISSUE_NUMBER --body "‚è±Ô∏è Auto-fix is taking longer than expected. Agent is still running. Check agent status manually."

